:icons: font
:sectanchors:
:toc: left
:toclevels: 2
:toc-title: Table of Content
:numbered:
:source-highlighter: highlight.js
= Keylcoak Workshop

toc::[]

== Installing the Keycloak Server

 * Grab a server binary link:http://www.keycloak.org/downloads.html[here]
 * Unzip it
 * Run it `KC_LOCATION/bin/standalone.sh -Djboss.socket.binding.port-offset=100`

[NOTE]
We run it with a port offset of 100 to make sure we don't conflict with 8080 for the apps we will be deploying.

== Creating the initial Admin user

Browse to `http://localhost:8180/auth` and you will be see this screen :

image::images/initAdmin.png[]

Create a new `admin` user with password `admin`.

Now you can access the Keycloak Web Console

== Configuring a new Realm

A good practice is to create a new Realm but you could keep doing this workshop on the `master` Realm.

You can name your realm as you want, in this workshop I will use `canoo`

image::images/newRealm.png[]

=== Creating the client, the role, and the user

 * Now we need to define a client, which will be our Spring Boot app. Go to the “Clients” section and click the “create” button. We will call our client “product-app”:
 * On the next screen, we can keep the defaults settings but just need to enter a valid redirect URL that Keycloak will use once the user is authenticated. Put as value: `http://localhost:8081/*`

[NOTE]
Don't forget to save !

Now, we will define a role that will be assigned to our users, let’s create a simple role called `user` :

image::images/role.png[]

Now, we need to set his credentials, so go to the credentials tab of your user and choose a password, I will be using “password” for the rest of this workshop, make sure to turn off the “Temporary” flag unless you want the user to have to change his password the first time he authenticates.

Finally proceed to the `Role Mappings` tab and assign the role “user” :

image::images/roleMapping.png[]

== Running the Spring Boot Product-app

Okay, we are ready to secure our first application, the `product-app` a simple Spring Boot Application using Spring MVC and Freemarker.

And let's create it from scratch !

Browse to link:https://start.spring.io/[The Spring Boot Initialzr] and add the following dependencies :

* Web
* Freemarker
* Keycloak

image::images/sbpage.png[]

Import the application in your favorite IDE, I will be using IntelliJ.

Our app will be simple and will contain only 2 pages:

* An index.html which will be the landing page containing just a link to the product page.
* Products.ftl which will be our product page template and will be only accessible for authenticated user.

Let’s start by creating in simple index.html file in `/src/resources/static`:

[source, html]
----

<html>
<head>
    <title>My awesome landing page</title>
</head>
 <body>
   <h1>Landing page</h1>
   <a href="/products">My products</a>
 </body>
</html>

----

Let's create our Controller and Service classes now

[NOTE]
You can create all the classes (Controller, etc) in the same Main file of your Spring Boot.

[source, java]
----
@Component
class ProductService {
   public List<String> getProducts() {
      return Arrays.asList("iPad","iPod","iPhone");
   }
}

@Controller
class ProductController {

   @Autowired ProductService productService;

   @GetMapping(path = "/products")
   public String getProducts(Model model){
      model.addAttribute("products", productService.getProducts());
      return "products";
   }

   @GetMapping(path = "/logout")
   public String logout(HttpServletRequest request) throws ServletException {
      request.logout();
      return "/";
   }
}

----

Final missing piece before you configure Keycloak is the product template, create this file in `sec/resources/templates` :

[source, html]
----

<#import "/spring.ftl" as spring>
<html>
<h1>My products</h1>
<ul>
<#list products as product>
    <li>${product}</li>
</#list>
</ul>
<p>
    <a href="/logout">Logout</a>
</p>
</html>

----

=== Configuring the Keycloak Adapter

Let's start by adding the mandatory fields :

[source, bash]
----

keycloak.auth-server-url=http://localhost:8180/auth
keycloak.realm=canoo
keycloak.public-client=true
keycloak.resource=product-app

----

Now, in this same property file, let's add some security constraints :

[source, bash]
----

keycloak.security-constraints[0].authRoles[0]=user
keycloak.security-constraints[0].securityCollections[0].patterns[0]=/products/*

----

Now we can run the app !

[NOTE]
`mvn clean spring-boot:run` or directly from your IDE.

=== The Login Page

Browse to `http://localhost:8080` and click the `products` link, you should be redirected to the Keycloak Login Page.

Login with the user you create in the first step and after Keycloak should redirect you back to your application showing the list of products.

==== Enabling user registration

Click the `logout` link and go back to the Login page.
Let's tweak our Login page using the Keycloak Web Console.

In the `Realm Settings` screen select the `Login` tab :

image::images/loginOptions.png[]

Turn on `User Registration`,  go back to the Login page and refresh.

[NOTE]
You can also "play" with the other options like `Remember me` etc ...

Click the `Register new user` link and fill in the form.

Notice that when you will be redirect to the application you will have an error. That's because you new user don't have the role `user`.

Make sure you add the role to your newly created user and let's also make sure the role user is added by default when an user is created :

image::images/defaultRole.png[]

In the Role section, you have a `Default Roles` tab, from there you can choose the default roles.

==== Enabling Spring Security
